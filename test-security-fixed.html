<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”’ Security-Fixed Environment Test</title>
    
    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Environment loaders -->
    <script src="./js/env-loader.js"></script>
    <script src="./js/netlify-env-injector.js"></script>
    <script src="./js/supabase-config.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .test-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <h1>ğŸ”’ Security-Fixed Supabase Environment Test</h1>
    <p>This page tests the new secure approach to environment variables that passes Netlify's security scanning.</p>

    <div id="overall-status" class="status info">â³ Running security-compliant tests...</div>

    <div class="test-grid">
        <div class="test-card">
            <h3>ğŸ” Environment Security Check</h3>
            <div id="security-status" class="status">â³ Checking for exposed secrets...</div>
            <pre id="security-result"></pre>
        </div>

        <div class="test-card">
            <h3>ğŸŒ Netlify Function Test</h3>
            <div id="function-status" class="status">â³ Testing Netlify function endpoint...</div>
            <pre id="function-result"></pre>
        </div>

        <div class="test-card">
            <h3>âš¡ Environment Loading Test</h3>
            <div id="env-status" class="status">â³ Testing environment loading...</div>
            <pre id="env-result"></pre>
        </div>

        <div class="test-card">
            <h3>ğŸ—„ï¸ Supabase Connection Test</h3>
            <div id="supabase-status" class="status">â³ Testing Supabase initialization...</div>
            <pre id="supabase-result"></pre>
        </div>
    </div>

    <div class="test-card">
        <h3>ğŸ” Build Information</h3>
        <pre id="build-info"></pre>
    </div>

    <script>
        let testResults = {};

        // Security check - verify no secrets are exposed in DOM
        function checkSecurity() {
            const securityStatus = document.getElementById('security-status');
            const securityResult = document.getElementById('security-result');
            
            const htmlContent = document.documentElement.outerHTML;
            const scriptContent = Array.from(document.scripts).map(s => s.textContent).join('');
            
            // Check for exposed secrets patterns
            const secretPatterns = [
                /VITE_SUPABASE_URL.*?https:\/\/[a-z0-9]+\.supabase\.co/gi,
                /VITE_SUPABASE_ANON_KEY.*?eyJ[A-Za-z0-9_-]+/gi,
                /"VITE_SUPABASE_URL":\s*"[^"]+"/gi,
                /"VITE_SUPABASE_ANON_KEY":\s*"[^"]+"/gi
            ];
            
            let foundSecrets = [];
            secretPatterns.forEach((pattern, index) => {
                const matches = (htmlContent + scriptContent).match(pattern);
                if (matches) {
                    foundSecrets.push(`Pattern ${index + 1}: ${matches.length} matches`);
                }
            });
            
            if (foundSecrets.length === 0) {
                securityStatus.textContent = 'âœ… No secrets exposed in DOM - Security compliant!';
                securityStatus.className = 'status success';
                securityResult.textContent = 'No environment variable values found in HTML/JS content.\nNetlify secrets scanning should pass.';
                testResults.security = true;
            } else {
                securityStatus.textContent = 'âŒ Potential secrets found in DOM';
                securityStatus.className = 'status error';
                securityResult.textContent = 'Found potential secrets:\n' + foundSecrets.join('\n') + '\n\nThis may cause Netlify build to fail.';
                testResults.security = false;
            }
        }

        // Test Netlify function
        async function testNetlifyFunction() {
            const functionStatus = document.getElementById('function-status');
            const functionResult = document.getElementById('function-result');
            
            try {
                const response = await fetch('/.netlify/functions/get-env');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.VITE_SUPABASE_URL && data.VITE_SUPABASE_ANON_KEY) {
                        functionStatus.textContent = 'âœ… Netlify function working correctly!';
                        functionStatus.className = 'status success';
                        functionResult.textContent = JSON.stringify({
                            status: 'Success',
                            VITE_SUPABASE_URL: data.VITE_SUPABASE_URL,
                            VITE_SUPABASE_ANON_KEY: '[PRESENT]',
                            other_vars: Object.keys(data).filter(k => !k.includes('SUPABASE'))
                        }, null, 2);
                        testResults.netlifyFunction = true;
                    } else {
                        throw new Error('Missing required environment variables in function response');
                    }
                } else {
                    throw new Error(`Function returned ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                functionStatus.textContent = 'âŒ Netlify function failed';
                functionStatus.className = 'status error';
                functionResult.textContent = `Error: ${error.message}\n\nFunction endpoint: /.netlify/functions/get-env`;
                testResults.netlifyFunction = false;
            }
        }

        // Test environment loading
        async function testEnvironmentLoading() {
            const envStatus = document.getElementById('env-status');
            const envResult = document.getElementById('env-result');
            
            try {
                const env = await getEnvironment();
                
                if (env && env.VITE_SUPABASE_URL && env.VITE_SUPABASE_ANON_KEY) {
                    envStatus.textContent = 'âœ… Environment variables loaded successfully!';
                    envStatus.className = 'status success';
                    envResult.textContent = JSON.stringify({
                        VITE_SUPABASE_URL: env.VITE_SUPABASE_URL,
                        VITE_SUPABASE_ANON_KEY: '[PRESENT]',
                        VITE_ENVIRONMENT: env.VITE_ENVIRONMENT || '[NOT SET]',
                        VITE_APP_NAME: env.VITE_APP_NAME || '[NOT SET]',
                        loading_method: 'Runtime fetching (secure)'
                    }, null, 2);
                    testResults.environment = true;
                } else {
                    throw new Error('Environment variables not loaded or incomplete');
                }
            } catch (error) {
                envStatus.textContent = 'âŒ Environment loading failed';
                envStatus.className = 'status error';
                envResult.textContent = `Error: ${error.message}`;
                testResults.environment = false;
            }
        }

        // Test Supabase connection
        async function testSupabaseConnection() {
            const supabaseStatus = document.getElementById('supabase-status');
            const supabaseResult = document.getElementById('supabase-result');
            
            try {
                const client = await initializeSupabase();
                
                if (client && typeof client.from === 'function') {
                    supabaseStatus.textContent = 'âœ… Supabase initialized and ready!';
                    supabaseStatus.className = 'status success';
                    supabaseResult.textContent = JSON.stringify({
                        client_available: true,
                        from_method: typeof client.from,
                        auth_available: !!client.auth,
                        storage_available: !!client.storage,
                        initialization: 'Secure runtime loading'
                    }, null, 2);
                    testResults.supabase = true;
                } else {
                    throw new Error('Supabase client not properly initialized');
                }
            } catch (error) {
                supabaseStatus.textContent = 'âŒ Supabase initialization failed';
                supabaseStatus.className = 'status error';
                supabaseResult.textContent = `Error: ${error.message}`;
                testResults.supabase = false;
            }
        }

        // Show build information
        function showBuildInfo() {
            const buildInfo = document.getElementById('build-info');
            
            const info = {
                'Current URL': window.location.href,
                'Is Netlify': window.location.hostname.includes('.netlify.'),
                'Build Markers': {
                    '__ENV_INJECTED__': !!window.__ENV_INJECTED__,
                    '__NETLIFY_ENV__': !!window.__NETLIFY_ENV__,
                    '__BUILD_ENV__': !!window.__BUILD_ENV__,
                    '__MANUAL_ENV__': !!window.__MANUAL_ENV__
                },
                'Available Functions': {
                    'getEnvironment': typeof window.getEnvironment,
                    'initializeSupabase': typeof window.initializeSupabase,
                    'supabase (CDN)': typeof window.supabase
                },
                'Meta Tags': {
                    'env:configured': !!document.querySelector('meta[name="env:configured"]'),
                    'env:netlify': !!document.querySelector('meta[name="env:netlify"]')
                }
            };

            buildInfo.textContent = JSON.stringify(info, null, 2);
        }

        // Update overall status
        function updateOverallStatus() {
            const overallStatus = document.getElementById('overall-status');
            const passedTests = Object.values(testResults).filter(Boolean).length;
            const totalTests = Object.keys(testResults).length;
            
            if (passedTests === totalTests && totalTests > 0) {
                overallStatus.textContent = 'âœ… All tests passed! Environment is secure and functional.';
                overallStatus.className = 'status success';
                document.title = 'âœ… Secure Supabase Working - ' + document.title;
            } else {
                overallStatus.textContent = `âŒ ${passedTests}/${totalTests} tests passed. Check failed tests above.`;
                overallStatus.className = 'status error';
                document.title = 'âŒ Issues Found - ' + document.title;
            }
        }

        // Run all tests
        window.addEventListener('load', async function() {
            console.log('ğŸ”’ Starting security-compliant Supabase tests...');
            
            // Wait for scripts to load
            setTimeout(async () => {
                checkSecurity();
                await testNetlifyFunction();
                await testEnvironmentLoading();
                await testSupabaseConnection();
                showBuildInfo();
                updateOverallStatus();
                
                console.log('ğŸ”’ Security-compliant test results:', testResults);
            }, 1000);
        });
    </script>
</body>
</html>
