<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Environment Test</title>
    
    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Environment Variables Loader (Netlify-compatible) -->
    <script src="./js/netlify-env-injector.js"></script>
    <!-- Fallback Environment Loader -->
    <script src="./js/env-loader.js"></script>
    <!-- Error Boundary -->
    <script src="./js/error-boundary.js"></script>
    
    <!-- Supabase Configuration -->
    <script src="./js/supabase-config.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            font-weight: bold;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <h1>🧪 Supabase Environment Variables Test</h1>
    <p>This page tests if environment variables and Supabase are properly configured on Netlify.</p>

    <div class="test-section">
        <h2>1. Environment Variables Test</h2>
        <div id="envStatus" class="status">⏳ Testing environment variables...</div>
        <button onclick="testEnvironment()">🔄 Retry Environment Test</button>
        <pre id="envResult"></pre>
    </div>

    <div class="test-section">
        <h2>2. Supabase Library Test</h2>
        <div id="supabaseLibStatus" class="status">⏳ Testing Supabase library...</div>
        <button onclick="testSupabaseLibrary()">🔄 Retry Supabase Library Test</button>
        <pre id="supabaseLibResult"></pre>
    </div>

    <div class="test-section">
        <h2>3. Supabase Client Test</h2>
        <div id="supabaseClientStatus" class="status">⏳ Testing Supabase client initialization...</div>
        <button onclick="testSupabaseClient()">🔄 Retry Supabase Client Test</button>
        <pre id="supabaseClientResult"></pre>
    </div>

    <div class="test-section">
        <h2>4. Debugging Information</h2>
        <button onclick="showDebuggingInfo()">🔍 Show Debug Info</button>
        <pre id="debugInfo"></pre>
    </div>

    <script>
        // Test results storage
        let testResults = {
            environment: null,
            supabaseLib: null,
            supabaseClient: null
        };

        // Test environment variables
        async function testEnvironment() {
            const statusEl = document.getElementById('envStatus');
            const resultEl = document.getElementById('envResult');
            
            statusEl.textContent = '⏳ Testing environment variables...';
            statusEl.className = 'status';

            try {
                const env = await getEnvironment();
                
                if (env && env.VITE_SUPABASE_URL && env.VITE_SUPABASE_ANON_KEY) {
                    statusEl.textContent = '✅ Environment variables loaded successfully!';
                    statusEl.className = 'status success';
                    testResults.environment = true;
                    
                    resultEl.textContent = JSON.stringify({
                        VITE_SUPABASE_URL: env.VITE_SUPABASE_URL,
                        VITE_SUPABASE_ANON_KEY: env.VITE_SUPABASE_ANON_KEY ? '[PRESENT]' : '[MISSING]',
                        VITE_ENVIRONMENT: env.VITE_ENVIRONMENT || '[NOT SET]',
                        VITE_APP_NAME: env.VITE_APP_NAME || '[NOT SET]',
                        VITE_APP_VERSION: env.VITE_APP_VERSION || '[NOT SET]'
                    }, null, 2);
                } else {
                    throw new Error('Missing required environment variables');
                }
            } catch (error) {
                statusEl.textContent = '❌ Environment variables test failed!';
                statusEl.className = 'status error';
                testResults.environment = false;
                resultEl.textContent = `Error: ${error.message}`;
            }
        }

        // Test Supabase library
        function testSupabaseLibrary() {
            const statusEl = document.getElementById('supabaseLibStatus');
            const resultEl = document.getElementById('supabaseLibResult');
            
            statusEl.textContent = '⏳ Testing Supabase library...';
            statusEl.className = 'status';

            if (window.supabase && window.supabase.createClient) {
                statusEl.textContent = '✅ Supabase library loaded successfully!';
                statusEl.className = 'status success';
                testResults.supabaseLib = true;
                
                resultEl.textContent = JSON.stringify({
                    'window.supabase': '✅ Available',
                    'createClient method': '✅ Available',
                    'library version': window.supabase.version || 'Unknown',
                    'available methods': Object.keys(window.supabase)
                }, null, 2);
            } else {
                statusEl.textContent = '❌ Supabase library not available!';
                statusEl.className = 'status error';
                testResults.supabaseLib = false;
                resultEl.textContent = `Error: Supabase library not loaded. Check if the CDN is accessible.`;
            }
        }

        // Test Supabase client initialization
        async function testSupabaseClient() {
            const statusEl = document.getElementById('supabaseClientStatus');
            const resultEl = document.getElementById('supabaseClientResult');
            
            statusEl.textContent = '⏳ Testing Supabase client initialization...';
            statusEl.className = 'status';

            try {
                const client = await initializeSupabase();
                
                if (client && typeof client.from === 'function') {
                    statusEl.textContent = '✅ Supabase client initialized successfully!';
                    statusEl.className = 'status success';
                    testResults.supabaseClient = true;
                    
                    resultEl.textContent = JSON.stringify({
                        'client object': '✅ Available',
                        'from method': '✅ Available',
                        'auth object': client.auth ? '✅ Available' : '❌ Missing',
                        'storage object': client.storage ? '✅ Available' : '❌ Missing',
                        'client methods': Object.keys(client).slice(0, 10) // Show first 10 methods
                    }, null, 2);
                } else {
                    throw new Error('Supabase client initialization failed');
                }
            } catch (error) {
                statusEl.textContent = '❌ Supabase client initialization failed!';
                statusEl.className = 'status error';
                testResults.supabaseClient = false;
                resultEl.textContent = `Error: ${error.message}`;
            }
        }

        // Show debugging information
        function showDebuggingInfo() {
            const debugEl = document.getElementById('debugInfo');
            
            const debugInfo = {
                'Current URL': window.location.href,
                'Is Netlify': window.location.hostname.includes('.netlify.'),
                'Protocol': window.location.protocol,
                'User Agent': navigator.userAgent,
                'Console Messages': 'Check browser console for detailed logs',
                'Window Objects': {
                    '__NETLIFY_ENV__': window.__NETLIFY_ENV__ ? '✅ Available' : '❌ Missing',
                    '__BUILD_ENV__': window.__BUILD_ENV__ ? '✅ Available' : '❌ Missing',
                    '__MANUAL_ENV__': window.__MANUAL_ENV__ ? '✅ Available' : '❌ Missing',
                    'getEnvironment': typeof window.getEnvironment,
                    'initializeSupabase': typeof window.initializeSupabase,
                    'supabase (CDN)': typeof window.supabase
                },
                'Test Results Summary': testResults
            };

            debugEl.textContent = JSON.stringify(debugInfo, null, 2);
        }

        // Run all tests on page load
        window.addEventListener('load', async function() {
            console.log('🧪 Starting comprehensive Supabase tests...');
            
            // Wait a bit for all scripts to load
            setTimeout(async () => {
                await testEnvironment();
                testSupabaseLibrary();
                await testSupabaseClient();
                showDebuggingInfo();
                
                // Show overall result
                const allPassed = testResults.environment && testResults.supabaseLib && testResults.supabaseClient;
                console.log(`🧪 Test Results: ${allPassed ? '✅ ALL TESTS PASSED' : '❌ SOME TESTS FAILED'}`);
                
                if (allPassed) {
                    document.title = '✅ Supabase Working - ' + document.title;
                } else {
                    document.title = '❌ Supabase Issues - ' + document.title;
                }
            }, 1000);
        });
    </script>
</body>
</html>
